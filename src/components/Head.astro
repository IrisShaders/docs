---
import type { Props } from '@astrojs/starlight/props'
import Default from '@astrojs/starlight/components/Head.astro'

const { entry } = Astro.locals.starlightRoute;
const ogImageUrl = new URL(
    `/og/${entry.id.replace(/\.\w+$/, '.png')}`,
    Astro.site,
)

const darkImages = Object.values(
	import.meta.glob('/src/assets/banners/dark/*', {
		eager: true,
		as: 'url',
	})
);
const lightImages = Object.values(
	import.meta.glob('/src/assets/banners/light/*', {
		eager: true,
		as: 'url',
	})
);
---

<Default {...Astro.props}><slot /></Default>

<meta property="og:image" content={ogImageUrl} />
<meta name="twitter:image" content={ogImageUrl} />

<script define:vars={{ darkImages, lightImages }}>
  function applySidebarBg() {
    const theme = document.documentElement.getAttribute('data-theme') || 'dark';
    const images = theme === 'light' ? lightImages : darkImages;
    const randomIndex = Math.floor(Math.random() * images.length);
    document.documentElement.style.setProperty(
      '--sidebar-bg-image', // what even is javascript?
      `url(${images[randomIndex]})`
    );
  }

  applySidebarBg();

  new MutationObserver((mutations) => {
    for (const m of mutations) {
      if (m.attributeName === 'data-theme') {
        applySidebarBg();
        return;
      }
    }
  }).observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
</script>